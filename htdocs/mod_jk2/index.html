<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0px; padding: 0px }
      #linz { height: 50%; width: 50%; opacity: 1; position:absolute; top:0; left:50%}
      #tokyo { height: 50%; width: 50%; opacity: 1; position:absolute; top:50%; left:50%}
      #streetview { height: 100%; width: 50%; opacity: 0.8;  position: absolute; top:0%; left: 0%}
      #flickr { position: absolute; top:100%; left: 0%}
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
    <script src="http://realtimeweblog.in:3000/socket.io/socket.io.js" type="text/javascript" charset="UTF-8"></script>
    <script src="http://maps.google.com/maps/api/js?v=3&sensor=false"
        type="text/javascript" charset="UTF-8"></script>

    <script type="text/javascript">
    //<![CDATA[

    var linz;
    var tokyo;
    var panorama;
    var $list;
    var marker;
    var zoom = 12; 

    function init() {
      $list = $('<ul><li></li></ul>').appendTo('body');

      // liniz
      var latlng = new google.maps.LatLng(48.309292, 14.284233);
      var opts = {
        zoom: zoom,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: latlng
      };
      linz = new google.maps.Map(document.getElementById("linz"), opts);
      
      // tokyo
      var latlng = new google.maps.LatLng(35.663411, 139.70502);
      var opts = {
        zoom: zoom,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: latlng
      };
      tokyo = new google.maps.Map(document.getElementById("tokyo"), opts);

      // streetview
      var panoramaOptions = {
        position: latlng,
        pov: {
          heading: 300,
          pitch: 0,
          zoom: 1
        }
      };
      panorama = new google.maps.StreetViewPanorama(document.getElementById("streetview"), panoramaOptions);
      tokyo.setStreetView(panorama);

      // flickr 
      var apikey = "2c9510f47c9fcfe73c451013e5f38014";
      var userid = "66914673@N05";

      flickr_init(apikey, userid);

      // marker
      var img = 'http://www.gravatar.com/avatar/0d22cf6120bdd1f4f70e9845a2c14793?d=https://gp1.wac.edgecastcdn.net/801245/assets1.socialcast.com/images/default_avatar_square45.png&s=45';
      marker = new google.maps.Marker({
          position: latlng, 
          //icon:img 
          map: linz
        });   

      // polyline
      polyline = new google.maps.Polyline({
        path: [],
        strokeColor: "#FF00FF",
        strokeOpacity: 0.75,
        strokeWeight: 5 
      });

      polyline.setMap(linz);

      // archived location
      archivepolyline = new google.maps.Polyline({
        path: [],
        strokeColor: "#0000FF",
        strokeOpacity: 0.5,
        strokeWeight: 5 
      });

      archivepolyline.setMap(linz);
      min = new Date().getTime() - 8 * 60 * 60 * 1000;
      min /= 1000;
      $.get('http://realtimeweblog.in/log/location?min=' + min + '&limit=10000', function(data) {
        if(data != undefined)
        {
          $.each(data.result, function(index, result) {
            if(result.data != undefined)
            {
              log('location', result.data);
              var latitude = result.data.latitude;
              var longitude = result.data.longitude;
              var latlng = new google.maps.LatLng(latitude, longitude);
              var path = archivepolyline.getPath();
              path.push(latlng);
              marker.setPosition(latlng);
              result.data.latitude += -12.645881;
              result.data.longitude += 125.420787;
              move(result.data);

            } 
          });
        }
      });

      // socket
      socket = io.connect('http://realtimeweblog.in:3000');
      socket.on('heading', function(data) {
        if(data != undefined)
        {
          log('heading', data);
          heading(data);
        }
      });
      socket.on('location', function(data) {
        if(data != undefined)
        {
        var latitude = data.latitude;
        var longitude = data.longitude;
        var latlng = new google.maps.LatLng(latitude, longitude);
        marker.setPosition(latlng);
          var path = polyline.getPath();
          path.push(latlng);
          log('location', data);
          data.latitude += -12.645881;
          data.longitude += 125.420787;
          move(data);
          
        }
      });
    };

    function heading(data) {
        var heading = data.trueHeading;
        panorama.setPov(
          {
            heading: heading,
            pitch: 1,
            zoom: 1
          }
        );
    }

    function move(data) {
        var latitude = data.latitude;
        var longitude = data.longitude;
        var latlng = new google.maps.LatLng(latitude, longitude);
        panorama.setPosition(
          latlng
        );
    }

    function log(type, data) {
        $list.prepend($('<li>' + type  + ': ' + JSON.stringify(data) + '</li>'));			
        if ($list.find('li').length > 10) {
            $list.find('li').last().remove();
        }
    }

    function flickr_init(key, id) {
      var req_url = "http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=" + key + "&user_id=" + id + "&sort=date-taken-desc&extras=geo,date_taken,owner_name&per_page=1000&page=1&format=json&jsoncallback=flickr_callback";
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = req_url;
      document.getElementsByTagName("head")[0].appendChild(script);
      return;
    }

    function flickr_callback(data) {
      $flickr = $('#flickr');
      $.each(data.photos.photo, function(index, photo) {
        console.log(JSON.stringify(photo));
        if(photo.latitude != 0 && photo.longitude != 0)
        {
          var title = photo.title + " id:" + photo.id + ' date:' + photo.datetaken;
          var latlng = new google.maps.LatLng(photo.latitude, photo.longitude);
          var imgurl = 'http://static.flickr.com/' + photo.server +'/'+ photo.id + '_' + photo.secret + '_s.jpg';
          var markerimage = new google.maps.MarkerImage(imgurl);
          markerimage.scaledSize = new google.maps.Size(20,20);
          markerimage.anchor = new google.maps.Point(10,10);
          var pageurl = 'http://www.flickr.com/photos/' + photo.owner + '/' + photo.id + '/';

          var marker = new google.maps.Marker({
            title: title,
            position: latlng, 
            icon: markerimage,
            zindex: 0,
            map: linz
          });
          var marker_tokyo = new google.maps.Marker({
            title: title,
            position: latlng,
            icon: markerimage,
            zindex: 0,
            map: tokyo
          });
          google.maps.event.addListener(marker, 'click', function() { window.open(pageurl, 'flickr'); });
          google.maps.event.addListener(marker, 'mouseover', function() { console.log('mouseover' + (this.describe)); this.scaledSize = new google.maps.Size(40, 40); });
          google.maps.event.addListener(marker_tokyo, 'click', function() { window.open(pageurl, 'flickr'); });
          //$flickr.prepend($('<img src="' + imgurl  + '" />'));			
        }
      });
    }

    //]]>
    </script>
  </head>
  <body onload="init()">
    <div id="tokyo"></div>
    <div id="linz"></div>
    <div id="streetview"></div>
    <div id="flickr"></div>
  </body>
</html>
